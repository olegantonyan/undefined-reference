<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
    <meta name="description" content="How to integrate Rust with Ruby" />
    <meta property="og:description" content="description" />
  
  
    <meta name="keywords" content="ruby, rust, gem, rubygem, native" />
  

  <meta property="og:url" content="https://undefined-reference.org/2016/05/14/writing-rubygem-in-rust.html" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="https://undefined-reference.org/assets/me_rounded.png" />
  <meta property="og:site_name" content="ruby and friends programming blog"/>

  
    <title>Writing Ruby gem in Rust</title>
    <meta property="og:title" content="Writing Ruby gem in Rust" />
  

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://undefined-reference.org/2016/05/14/writing-rubygem-in-rust.html">
  <link rel="alternate" type="application/rss+xml" title="undefined reference" href="https://undefined-reference.org/feed.xml">
  <link rel="stylesheet" href="/css/font-awesome-4.4.0/css/font-awesome.min.css">
</head>


  <body>

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">undefined reference</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        
          
        
          
        
          
        
          
          <a class="page-link" href="/about/">About</a>
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <a class="page-link" href="/feed.xml">RSS</a>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Writing Ruby gem in Rust</h1>
    <i class="fa fa-tags"></i>
    
      <a href="/tag/ruby">ruby</a>
    
      <a href="/tag/rust">rust</a>
    
    <p class="post-meta"><i class="fa fa-calendar"></i>
      <time datetime="2016-05-14T05:12:28+00:00" itemprop="datePublished">May 14, 2016</time>
      
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>TL;DR: here is an <a href="https://github.com/olegantonyan/rustygem">example of a gem written in Rust</a>.</p>

<h4 id="why">Why?</h4>

<p>Ruby is slow, right? Most of the time we don’t care, but sometimes we do. And when we do, there are not so many options: C, C++, microservices/rpc/jruby, … . C is good enough to shot yourself in the foot. C++, well, just C++. Other options are to comprehensive for a simple task, like CPU intensive algorithm. You can probably use Go, but it has its own runtime with garbage collector which adds more overhead.</p>

<p>Rust is another option because of:</p>

<ul>
  <li>safety</li>
  <li>speed</li>
  <li>no runtime</li>
</ul>

<p>There are couple of challenges with Ruby-Rust integration (actually, for Ruby-whatever integration). This post is about them.</p>

<h4 id="passing-data-between-ruby-and-rust">Passing data between Ruby and Rust</h4>

<p>This is relatively easy when you are passing simple integers, but if you need to pass complex objects there is a lot of headache. You can avoid it by using JSON and passing it as string. If you need to call a function in Rust and get result of its CPU intensive calculation, then it’s OK to have JSON overhead.</p>

<p>One gotcha is that you have to deallocate memory allocated for <code class="language-plaintext highlighter-rouge">char *</code> inside Rust after it has been returned to Ruby. That’s why we have <code class="language-plaintext highlighter-rouge">rust_free</code> function in Rust, which is a wrapper for libc’s <code class="language-plaintext highlighter-rouge">free</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'rustygem/version'</span>
<span class="nb">require</span> <span class="s1">'fiddle'</span>
<span class="nb">require</span> <span class="s1">'json'</span>

<span class="k">module</span> <span class="nn">Rustygem</span>
  <span class="vi">@lib</span> <span class="o">=</span> <span class="no">Fiddle</span><span class="p">.</span><span class="nf">dlopen</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="no">File</span><span class="p">.</span><span class="nf">dirname</span><span class="p">(</span><span class="kp">__FILE__</span><span class="p">)</span><span class="si">}</span><span class="s2">/../rust/target/release/librustygem.so"</span><span class="p">)</span>
  <span class="vi">@rust_perform</span> <span class="o">=</span> <span class="no">Fiddle</span><span class="o">::</span><span class="no">Function</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@lib</span><span class="p">[</span><span class="s1">'rust_perform'</span><span class="p">],</span> <span class="p">[</span><span class="no">Fiddle</span><span class="o">::</span><span class="no">TYPE_VOIDP</span><span class="p">],</span> <span class="no">Fiddle</span><span class="o">::</span><span class="no">TYPE_VOIDP</span><span class="p">)</span>
  <span class="vi">@rust_free</span> <span class="o">=</span> <span class="no">Fiddle</span><span class="o">::</span><span class="no">Function</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="vi">@lib</span><span class="p">[</span><span class="s1">'rust_free'</span><span class="p">],</span> <span class="p">[</span><span class="no">Fiddle</span><span class="o">::</span><span class="no">TYPE_VOIDP</span><span class="p">],</span> <span class="no">Fiddle</span><span class="o">::</span><span class="no">TYPE_VOID</span><span class="p">)</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">perform</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
    <span class="n">ptr</span> <span class="o">=</span> <span class="vi">@rust_perform</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">arg</span><span class="p">.</span><span class="nf">to_json</span><span class="p">)</span> <span class="c1"># do the actual work</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">.</span><span class="nf">to_s</span>
    <span class="vi">@rust_free</span><span class="p">.</span><span class="nf">call</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="c1"># char* was allocated in Rust, so don't forget to free it</span>
    <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-rust highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">#[no_mangle]</span>
<span class="k">pub</span> <span class="k">extern</span> <span class="s">"C"</span> <span class="k">fn</span> <span class="nf">rust_free</span><span class="p">(</span><span class="n">c_ptr</span><span class="p">:</span> <span class="o">*</span><span class="k">mut</span> <span class="nn">libc</span><span class="p">::</span><span class="nb">c_void</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">unsafe</span> <span class="p">{</span>
        <span class="nn">libc</span><span class="p">::</span><span class="nf">free</span><span class="p">(</span><span class="n">c_ptr</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Check out <a href="https://github.com/olegantonyan/rustygem">rustygem</a> for more details.</p>

<h4 id="building-dynamic-library-when-installing-the-gem">Building dynamic library when installing the gem</h4>

<p>Ruby gems have builtin mechanism for building native extensions in C. But what about Rust? Actually, we don’t need any external tools to build Rust library because in Rust we have Cargo which is very similar to bundler. So, the only thing we need to do is call <code class="language-plaintext highlighter-rouge">cargo build</code> inside Rust project. But how to do this when installing the gem? Turns out this is very simple. Just put <code class="language-plaintext highlighter-rouge">Makefile</code> along with empty <code class="language-plaintext highlighter-rouge">extconf.rb</code> and add <code class="language-plaintext highlighter-rouge">extconf.rb</code> to gemspec.</p>

<div class="language-makefile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># rust/Makefile:
</span><span class="nl">all</span><span class="o">:</span>
	cargo build <span class="nt">--release</span>

<span class="nl">clean</span><span class="o">:</span>
	<span class="nb">rm</span> <span class="nt">-rf</span> target

<span class="nl">install</span><span class="o">:</span> <span class="nf">;</span>
</code></pre></div></div>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># gemspec</span>
<span class="n">spec</span><span class="p">.</span><span class="nf">extensions</span> <span class="o">=</span> <span class="no">Dir</span><span class="p">[</span><span class="s1">'rust/extconf.rb'</span><span class="p">]</span>
</code></pre></div></div>

<p>Optionally, you can put some checks into <code class="language-plaintext highlighter-rouge">extconf.rb</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># rust/extconf.rb</span>
<span class="k">raise</span> <span class="s1">'You have to install Rust with Cargo (https://www.rust-lang.org/)'</span> <span class="k">if</span> <span class="o">!</span><span class="nb">system</span><span class="p">(</span><span class="s1">'cargo --version'</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nb">system</span><span class="p">(</span><span class="s1">'rustc --version'</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="conclusion">Conclusion</h3>

<p>There is an alternative to C. And it’s not so hard to use Rust in Ruby project.</p>

<p>This post illustrates very basic approach to integration Rust with Ruby. There is <a href="https://github.com/rustbridge/helix">Helix project</a> which is much more comprehensive. Check it out if you want less boilerplate and more nice API.</p>

<h3 id="links">Links</h3>
<ul>
  <li><a href="https://github.com/olegantonyan/rustygem">rustygem - an example gem written in Rust</a></li>
  <li><a href="http://blog.skylight.io/bending-the-curve-writing-safe-fast-native-gems-with-rust/">Bending the Curve: Writing Safe &amp; Fast Native Gems With Rust</a></li>
  <li><a href="https://github.com/rustbridge/helix">Helix project</a></li>
  <li><a href="http://stackoverflow.com/questions/37102967/how-can-i-build-a-rust-library-when-installing-a-gem">SO: How can I build a Rust library when installing a gem?</a></li>
  <li><a href="http://confreaks.tv/videos/railsconf2016-turbo-rails-with-rust">Turbo Rails with Rust by Godfrey Chan</a></li>
  <li><a href="https://github.com/flajann2/juwelier">Opinionated tool for creating and managing Rubygem projects using Ruby 2.3 and beyond. Supports Rusty gems</a></li>
</ul>

  </div>

  <div class="social-share">
    <span class="reddit-share">
      <a href="//www.reddit.com/submit" onclick="window.location = '//www.reddit.com/submit?url=' + encodeURIComponent(window.location); return false"> <img src="//www.redditstatic.com/spreddit1.gif" alt="submit to reddit" border="0" /> </a>
    </span>
  </div>

</article>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-3">
        <ul class="contact-list">
          <li>Oleg Antonyan</li>
          <li>
            <a href="/about"><img src="/assets/me_rounded.png" height="60em" width="60em"></a>
          </li>
          <li>
            <div class="social-links">
  <a href="" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  <a href="https://bitbucket.org/antlabs_dev" target="_blank">
    <i class="fa fa-bitbucket"></i>
  </a>
  <a href="http://stackoverflow.com/users/1837084/oleg-antonyan" target="_blank">
    <i class="fa fa-stack-overflow"></i>
  </a>
  <a href="https://www.linkedin.com/in/oleg-antonyan-2b715089" target="_blank">
    <i class="fa fa-linkedin"></i>
  </a>
  <a href="https://angel.co/oleg-antonyan" target="_blank">
    <i class="fa fa-angellist"></i>
  </a>
</div>

          </li>
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>
          undefined reference :: ruby and friends programming blog
        </p>
        <p>
          Build with <a href="http://jekyllrb.com/" target="_blank">Jekyll</a>, hosted on <a href="https://pages.github.com/" target="_blank">Github Pages</a>
        </p>
        <p>
          <a href="https://github.com/olegantonyan/undefined-reference" target="_blank">Source code</a>
        </p>
      </div>

    </div>

  </div>

</footer>


  </body>

</html>
